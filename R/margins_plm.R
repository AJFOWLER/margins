#' @rdname margins.plm
#' @title Marginal Effects for Panel Regression Models
#' @description Calculate marginal effects from estimated panel linear and panel generalized linear models
#' @param model A model object of class \dQuote{plm} or \dQuote{pglm}, from the \pkg{plm} package.
#' @param data A data.frame containing the data at which to evaluate the marginal effects, as in \code{\link[stats]{predict}}.
#' @param at A list of one or more named vectors, specifically values at which to calculate the marginal effects. See \code{\link{build_datalist}} for details on use.
#' @param \dots Arguments passed to \code{\link{marginal_effects}}. One of particular relevance for GLMs is \code{type}.
#' @return An object of class \dQuote{marginslist}, composed of one or more objects of class \dQuote{margins}.
#' @seealso \code{\link{plot.margins}}, \code{\link{extract_marginal_effects}}
#' @keywords models
#' @export
margins.plm <- 
function(model, 
         data = NULL, 
         at = NULL, 
         ...) {
    
    # setup data
    if (missing(data)) {
        if (!is.null(model[["call"]][["data"]])) {
            data <- eval(model[["call"]][["data"]], parent.frame()) 
        } else { 
            data <- get_all_vars(model[["terms"]], data = model[["model"]])
        }
    }
    data_list <- build_datalist(data, at = at)
    
    # reduce memory profile
    model[["model"]] <- NULL
    
    # calculate marginal effects
    warning("Marginal effects not likely to be correct")
    out <- lapply(data_list, function(thisdata) {
        m <- build_margins(model = model, data = thisdata, ...)
        attr(m, "at") <- attributes(thisdata)[["at"]]
        m
    })
    
    # return value
    structure(out, class = "marginslist")
}

#' @rdname margins.plm
#' @export
margins.pglm <- 
function(model, 
         data = NULL, 
         at = NULL, 
         ...){
    # setup data
    if (missing(data)) {
        if (!is.null(model[["call"]][["data"]])) {
            data <- eval(model[["call"]][["data"]], parent.frame()) 
        } else { 
            data <- get_all_vars(model[["terms"]], data = model[["model"]])
        }
    }
    data_list <- build_datalist(data, at = at)
    
    # reduce memory profile
    model[["model"]] <- NULL
    
    # calculate marginal effects
    warning("Marginal effects not likely to be correct")
    out <- lapply(data_list, function(thisdata) {
        m <- build_margins(model = model, data = thisdata, ...)
        attr(m, "at") <- attributes(thisdata)[["at"]]
        m
    })
    
    # return value
    structure(out, class = "marginslist")
}
